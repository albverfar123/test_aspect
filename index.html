<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PlujaCat - Radar i Acumulats</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, system-ui, sans-serif; background: #f0f0f0; }
        
        .header {
            position: absolute; top: 0; left: 0; right: 0; height: 60px;
            background: #1a1a1a; color: white; display: flex; align-items: center;
            justify-content: space-between; padding: 0 16px; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .header-tabs { display: flex; gap: 4px; }
        .header-tabs button {
            background: transparent; border: none; color: #aaa; padding: 6px 8px;
            cursor: pointer; font-weight: bold; font-size: 11px; border-radius: 6px;
            text-transform: uppercase;
        }
        .header-tabs button.active { background: #007bff; color: white; }
        #btnAspect { border: 1px solid #444; margin-left: 5px; }
        #btnAspect.active { border-color: #ff00ac; color: #ff00ac; }

        #map { position: absolute; top: 60px; bottom: 0; width: 100%; z-index: 1; }

        .control {
            position: absolute; background: white; z-index: 1500; padding: 15px;
            display: flex; flex-direction: column; gap: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease; box-sizing: border-box;
        }

        @media (min-width: 601px) {
            .control:not(#aspectControl) { top: 80px; right: 20px; width: 280px; border-radius: 12px; }
            .control.minimized { transform: translateX(350px); }
        }

        @media (max-width: 600px) {
            .control:not(#aspectControl) { bottom: 0; left: 0; width: 100%; border-radius: 20px 20px 0 0; }
            .control.minimized { transform: translateY(100%); }
        }

        #aspectControl { display: none; bottom: 80px; left: 20px; width: 140px; border-radius: 8px; z-index: 1501; }

        /* BOT√ì MEN√ö PUJAT A 65px */
        #btnToggleMenu {
            position: absolute; top: 65px; right: 20px; z-index: 1600;
            background: white; border: none; padding: 10px 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; font-weight: bold;
        }
        #btnGPS {
            position: absolute; top: 65px; left: 20px; z-index: 1600;
            background: white; border: 1px solid #ccc; width: 40px; height: 40px; 
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
        }
        .station-label {
            background: rgba(255, 255, 255, 0.9); border: 1px solid #666;
            border-radius: 3px; text-align: center; font-size: 10px; font-weight: bold;
        }
        .legend-box { background: white; padding: 10px; border-radius: 8px; width: 200px; font-size: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .colorbar { height: 12px; width: 100%; border: 1px solid #999; margin-top: 15px; position: relative; background: linear-gradient(to right,#30123b, #4662d8, #36aaf9, #1ae4b6, #a2fc3c, #faba39, #e4460a, #7a0403); }
        .colorbar span { position: absolute; height: 5px; border-left: 1px solid #333; top: -14px; }
        .ticks { position: relative; width: 100%; height: 12px; margin-top: 2px; }
        .ticks span { position: absolute; transform: translateX(-50%); }
    </style>
</head>
<body>

<div class="header">
    <div id="titleHeader" style="font-weight:bold">PlujaCat</div>
    <div class="header-tabs">
        <button id="modeRadar">Radar</button>
        <button id="modeDaily" class="active">Diari</button>
        <button id="modeWeekly">Setmanal</button>
        <button id="btnAspect">Orientaci√≥</button> 
    </div>
</div>

<button id="btnToggleMenu">Men√∫</button>
<button id="btnGPS">üìç</button>
    
<div id="map"></div>

<div class="control" id="mainControl">
    <div id="displayInfo" style="font-size:12px; color:#007bff; font-weight:bold; text-align:center; margin-bottom:5px;">--</div>
    
    <input id="datePicker" type="date" style="width:100%; padding:10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom:5px;">
    
    <div style="display:flex; gap:8px; margin-bottom:10px;">
        <button id="prevBtn" style="flex:1; padding: 12px; background:#eee; border:1px solid #ccc; border-radius:6px; cursor:pointer;">‚óÄ Anterior</button>
        <button id="nextBtn" style="flex:1; padding: 12px; background:#eee; border:1px solid #ccc; border-radius:6px; cursor:pointer;">Seg√ºent ‚ñ∂</button>
    </div>

    <div id="statusMsg" style="font-size:12px; text-align:center; color: #666;">Iniciant...</div>

    <label id="labelStations" style="font-size:13px; display:flex; align-items:center; gap:8px; padding: 5px 0;">
        <input type="checkbox" id="checkStations" checked> Veure estacions (mm)
    </label>
    
    <div style="font-size: 11px; color: #666; margin-top: 5px;">Opacitat Capa:</div>
    <input id="opacitySlider" type="range" min="0" max="1" step="0.1" value="0.8" style="width:100%; cursor:pointer;">
</div>

<div id="aspectControl" class="control">
    <div style="font-size: 11px; font-weight: bold;">Orientaci√≥ (Opacitat)</div>
    <input id="aspectOpacity" type="range" min="0" max="1" step="0.1" value="0.7" style="width:100%;">
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var map = L.map('map', { zoomControl: false, maxZoom: 22 }).setView([41.7, 1.8], 7);
L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);

var overlayRadar = null;
var aspectLayer = null; 
var stationsLayer = L.layerGroup().addTo(map);
var viewMode = 'daily'; 
var radarBounds = null;

var radarTime = new Date(); 
radarTime.setMinutes(Math.floor(radarTime.getMinutes() / 6) * 6);
radarTime.setSeconds(7); 

// --- LLEGENDA ---
var legend = L.control({ position: "bottomright" });
legend.onAdd = function() {
    this._div = L.DomUtil.create("div", "legend-box");
    this.update();
    return this._div;
};
legend.update = function() {
    let title = (viewMode === 'daily') ? "Acumulat Diari (mm)" : (viewMode === 'weekly' ? "Acumulat Setmanal (mm)" : "Intensitat Radar");
    let marks = "", ticks = "";
    const pts = (viewMode === 'weekly') ? [0.1, 1, 10, 50, 100, 300] : [0.1, 1, 5, 20, 100, 200];
    const logMax = (viewMode === 'weekly') ? 3.477 : 3.301;

    pts.forEach(v => {
        let pos = ((Math.log10(v) + 1) / logMax) * 100;
        marks += `<span style="left:${pos}%"></span>`;
        ticks += `<span style="left:${pos}%">${v}</span>`;
    });
    this._div.innerHTML = `<strong>${title}</strong><div class="colorbar">${marks}</div><div class="ticks">${ticks}</div>`;
};
legend.addTo(map);

// --- CORE ---
async function initMap() {
    try {
        const response = await fetch('bounds.json');
        const b = await response.json();
        // Guardem els bounds de forma estricta
        radarBounds = [[b.lat_min, b.lon_min], [b.lat_max, b.lon_max]];
    } catch (e) { 
        radarBounds = [[40.057, 0.151], [42.849, 3.487]]; 
    }
    updateView(); 
}

// Funci√≥ unificada per carregar qualsevol PNG (Radar o Acumulat)
// Aix√≤ garanteix que es facin servir els mateixos bounds sempre
function loadOverlay(path, callback) {
    if (overlayRadar) {
        map.removeLayer(overlayRadar);
        overlayRadar = null;
    }

    const img = new Image();
    img.onload = () => {
        // Apliquem radarBounds de forma id√®ntica per a tot tipus de PNG
        overlayRadar = L.imageOverlay(path, radarBounds, { 
            opacity: document.getElementById("opacitySlider").value,
            zIndex: 500 
        }).addTo(map);
        
        if(aspectLayer) overlayRadar.bringToFront();
        document.getElementById("statusMsg").textContent = "‚úî Carregat";
        if(callback) callback(true);
    };
    img.onerror = () => { 
        document.getElementById("statusMsg").textContent = "‚úñ No hi ha dades"; 
        if(callback) callback(false); 
    };
    img.src = path;
}

async function updateView() {
    if (!radarBounds) return;
    legend.update();
    const dates = getDates(document.getElementById("datePicker").value);
    const infoDisplay = document.getElementById("displayInfo");
    
    stationsLayer.clearLayers();

    if (viewMode === 'radar') {
        document.getElementById("labelStations").style.display = "none";
        infoDisplay.style.display = "block";
        let ymd = radarTime.toISOString().slice(0,10).replace(/-/g, "");
        let hms = radarTime.toTimeString().slice(0,8).replace(/:/g, "");
        infoDisplay.textContent = `RADAR: ${radarTime.toLocaleDateString()} ${radarTime.toLocaleTimeString().slice(0,5)}`;
        loadOverlay(`dades_radar_png/radar_${ymd}_${hms}.png`);
    } else {
        document.getElementById("labelStations").style.display = "flex";
        if (viewMode === 'daily') {
            infoDisplay.style.display = "none";
            loadOverlay(`acumulats_diaris/acumulat_${dates.daily}.png`);
            loadStations(`acumulats_diaris/estacions_${dates.daily}.json`);
        } else {
            infoDisplay.style.display = "block";
            loadOverlay(`acumulats_setmanals/setmanal_${dates.weeklyStart}_${dates.weeklyEnd}.png`, (success) => {
                if (!success) {
                    infoDisplay.textContent = `Setmana: ${dates.uiStart} - ${dates.uiEnd}`;
                    loadOverlay(`acumulats_setmanals/setmanal_${dates.trialStart}_${dates.trialEnd}.png`);
                    loadStations(`acumulats_setmanals/estacions_${dates.trialStart}_${dates.trialEnd}.json`);
                } else {
                    infoDisplay.textContent = `Setmana: ${dates.uiStartNat} - ${dates.uiEndNat}`;
                    loadStations(`acumulats_setmanals/estacions_${dates.weeklyStart}_${dates.weeklyEnd}.json`);
                }
            });
        }
    }
}

async function loadStations(path) {
    if (!document.getElementById("checkStations").checked) return;
    try {
        const res = await fetch(path);
        const data = await res.json();
        L.geoJSON(data, {
            pointToLayer: (feature, latlng) => L.marker(latlng, {
                icon: L.divIcon({ className: 'station-label', html: feature.properties.pluja, iconSize: [25, 15] })
            }).bindTooltip(`${feature.properties.nom}: ${feature.properties.pluja} mm`)
        }).addTo(stationsLayer);
    } catch (e) {}
}

function getDates(dateIn) {
    let d = new Date(dateIn);
    const fmt = (date) => date.toISOString().slice(0,10).replace(/-/g, "");
    const fmtUI = (date) => `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
    let monday = new Date(d); monday.setDate(d.getDate() - (d.getDay() === 0 ? 6 : d.getDay() - 1));
    let sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
    return {
        daily: fmt(d), weeklyStart: fmt(monday), weeklyEnd: fmt(sunday),
        trialStart: fmt(new Date(d.getTime() - 6*86400000)), trialEnd: fmt(d),
        uiStart: fmtUI(new Date(d.getTime() - 6*86400000)), uiEnd: fmtUI(d),
        uiStartNat: fmtUI(monday), uiEndNat: fmtUI(sunday)
    };
}

// --- EVENTS ---
document.getElementById("datePicker").onchange = function() {
    if (viewMode === 'radar') {
        let newD = new Date(this.value);
        radarTime.setFullYear(newD.getFullYear(), newD.getMonth(), newD.getDate());
    }
    updateView();
};

document.getElementById("prevBtn").onclick = () => {
    if (viewMode === 'radar') radarTime.setMinutes(radarTime.getMinutes() - 6);
    else { let d = new Date(document.getElementById("datePicker").value); d.setDate(d.getDate()-1); document.getElementById("datePicker").value = d.toISOString().slice(0,10); }
    syncDatePicker(); updateView();
};

document.getElementById("nextBtn").onclick = () => {
    if (viewMode === 'radar') radarTime.setMinutes(radarTime.getMinutes() + 6);
    else { let d = new Date(document.getElementById("datePicker").value); d.setDate(d.getDate()+1); document.getElementById("datePicker").value = d.toISOString().slice(0,10); }
    syncDatePicker(); updateView();
};

function syncDatePicker() { if(viewMode === 'radar') document.getElementById("datePicker").value = radarTime.toISOString().slice(0,10); }

document.getElementById("modeRadar").onclick = function() { changeMode('radar', this); };
document.getElementById("modeDaily").onclick = function() { changeMode('daily', this); };
document.getElementById("modeWeekly").onclick = function() { changeMode('weekly', this); };

function changeMode(m, btn) {
    viewMode = m;
    document.querySelectorAll('.header-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    syncDatePicker();
    updateView();
}

document.getElementById("btnToggleMenu").onclick = () => document.getElementById("mainControl").classList.toggle("minimized");
document.getElementById("btnGPS").onclick = () => map.locate({setView: true, maxZoom: 14});
map.on('locationfound', (e) => L.circleMarker(e.latlng, { radius: 8, className: 'user-location-dot', fillColor: '#007bff', fillOpacity: 1, color: 'white', weight: 2 }).addTo(map));

document.getElementById("btnAspect").onclick = function() {
    if (!aspectLayer) {
        this.classList.add("active"); document.getElementById("aspectControl").style.display = "flex";
        aspectLayer = L.tileLayer('https://albverfar123.github.io/meteo_prova/tiles_aspect/{z}/{x}/{y}.png', { opacity: 0.7, zIndex: 10 }).addTo(map);
    } else {
        this.classList.remove("active"); document.getElementById("aspectControl").style.display = "none";
        map.removeLayer(aspectLayer); aspectLayer = null;
    }
};
document.getElementById("opacitySlider").oninput = function() { if(overlayRadar) overlayRadar.setOpacity(this.value); };
document.getElementById("aspectOpacity").oninput = function() { if(aspectLayer) aspectLayer.setOpacity(this.value); };

// --- INIT ---
let dInit = new Date(); dInit.setDate(dInit.getDate()-1);
document.getElementById("datePicker").value = dInit.toISOString().slice(0,10);
initMap();
</script>
</body>
</html>
