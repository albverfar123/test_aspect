<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Precipitaci√≥ Catalunya, radar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, system-ui, sans-serif; }
        .header {
            position: absolute; top: 0; left: 0; right: 0; height: 60px;
            background: #1a1a1a; color: white; display: flex; align-items: center;
            justify-content: space-between; padding: 0 16px; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .header-tabs button {
            background: transparent; border: none; color: #aaa; padding: 6px 12px;
            cursor: pointer; font-weight: bold; font-size: 12px; border-radius: 6px;
        }
        .header-tabs button.active { background: #007bff; color: white; }
        
        #btnAspect { border: 1px solid #444; margin-left: 10px; }
        #btnAspect.active { border-color: #ff00ac; color: #ff00ac; }

        #map { position: absolute; top: 60px; bottom: 0; width: 100%; background: #f0f0f0; }
        .control {
            position: absolute; background: white; z-index: 1500; padding: 15px;
            display: flex; flex-direction: column; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .control.minimized { transform: translateX(calc(100% + 20px)); }

        #aspectControl {
            display: none; 
            bottom: 20px; left: 160px; width: 140px; border-radius: 8px;
        }

        .station-label {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 3px;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            pointer-events: none !important;
        }

        .legend {
            padding: 8px; background: white; line-height: 14px; color: #333;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 10px;
        }
        .legend i { width: 12px; height: 12px; float: left; margin-right: 5px; opacity: 0.9; border: 1px solid #ccc; }

        /* Estils Nova Llegenda Radar */
        .legend-box {
            background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 220px; min-height: 45px;
        }
        .colorbar {
            height: 12px; width: 100%; position: relative; margin-top: 5px; border: 1px solid #999;
            background: linear-gradient(to right,#30123b, #4662d8, #36aaf9, #1ae4b6, #a2fc3c, #faba39, #e4460a, #7a0403);
        }
        .colorbar span { position: absolute; height: 5px; border-left: 1px solid #333; top: -14px; }
        .ticks { position: relative; width: 100%; height: 12px; margin-top: 2px; }
        .ticks span { position: absolute; font-size: 9px; transform: translateX(-50%); }

        #btnToggleMenu {
            position: absolute; top: 65px; right: 20px; z-index: 1600;
            background: white; border: none; padding: 8px 12px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; font-weight: bold; font-size: 12px;
        }

        @media (min-width: 601px) { .control:not(#aspectControl) { top: 80px; right: 20px; width: 260px; border-radius: 12px; } }
        @media (max-width: 600px) { 
            .control:not(#aspectControl) { bottom: 0; width: 100%; border-radius: 20px 20px 0 0; box-sizing: border-box; } 
            .control.minimized { transform: translateY(100%); }
            #aspectControl { bottom: 180px; left: 135px; width: 110px; padding: 6px;}
            #btnToggleMenu { top: 65px; right: 10px; }
        }
        
        /* Bot√≥ GPS a dalt a l'esquerra */
        #btnGPS {
            position: absolute; 
            top: 70px; 
            left: 10px; 
            z-index: 1600;
            background: white; 
            border: 1px solid #ccc; 
            width: 34px; 
            height: 34px; 
            border-radius: 4px; /* M√©s quadrat, estil Leaflet */
            box-shadow: 0 1px 5px rgba(0,0,0,0.4); 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px;
        }
        
        /* Punt blau d'ubicaci√≥ */
        .user-location-dot {
            background-color: #007bff;
            border: 2px solid white;
            border-radius: 50%;
        }
        
        /* Ajust de l'escala perqu√® no trepitgi el bot√≥ */
        .leaflet-control-scale {
            margin-left: 10px !important;
            margin-top: 50px !important; /* Baixa l'escala per deixar lloc al bot√≥ */
        }
        
    </style>
</head>
<body>

<div class="header">
    <div id="titleHeader" style="font-weight:bold">PlujaCat</div>
    <div class="header-tabs">
        <button id="modeDaily" class="active">DIARI</button>
        <button id="modeWeekly">SETMANAL</button>
        <button id="btnAspect">Orientaci√≥</button> 
    </div>
</div>

<button id="btnToggleMenu">Men√∫</button>
<button id="btnGPS" title="ubicaci√≥">üìç</button>
    
<div id="map"></div>

<div class="control" id="mainControl">
    <div id="weekRangeDisplay" style="font-size:11px; color:#007bff; font-weight:bold; text-align:center; display:none; margin-bottom:5px;">--</div>
    <input id="datePicker" type="date" style="width:100%; padding:8px; margin-bottom:5px;">
    
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <button id="prevBtn" style="flex:1">‚óÄ</button>
        <button id="nextBtn" style="flex:1">‚ñ∂</button>
    </div>

    <div id="statusMsg" style="font-size:12px; text-align:center; margin-bottom:5px;">Iniciant...</div>

    <label style="font-size:12px; display:flex; align-items:center; gap:5px;">
        <input type="checkbox" id="checkStations" checked> Veure dades estacions (mm)
    </label>
    
    <div style="font-size: 10px; color: #666;">Opacitat Radar:</div>
    <input id="opacitySlider" type="range" min="0" max="1" step="0.1" value="0.8" style="width:100%;">
</div>

<div id="aspectControl" class="control">
    <div style="font-size: 10px; font-weight: bold; margin-bottom: 2px;">Aspecte (Opacitat)</div>
    <input id="aspectOpacity" type="range" min="0" max="1" step="0.1" value="0.7" style="width:100%; cursor:pointer;">
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var map = L.map('map', { zoomControl: false, maxZoom: 22 }).setView([41.7, 1.8], 7);
L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);

L.control.scale({
    metric: true,
    imperial: false,
    position: 'topleft' // Ara a dalt a l'esquerra
}).addTo(map);
    
var overlayRadar = null;
var aspectLayer = null; 
var legendControl = null; 
var stationsLayer = L.layerGroup().addTo(map);
var viewMode = 'daily';
var radarBounds = null;

// --- LLEGENDA DIN√ÄMICA ---
var legend = L.control({ position: "bottomright" });
legend.onAdd = function() {
    this._div = L.DomUtil.create("div", "legend-box");
    this.update();
    return this._div;
};

legend.update = function() {
    let title = viewMode === 'daily' ? "Acumulat Diari (mm)" : "Acumulat Setmanal (mm)";
    let marks = "";
    let ticks = "";

    if (viewMode === 'daily') {
        const d = 3.301;
        const pts = [0.1, 1, 5, 20, 100, 200];
        pts.forEach(v => {
            let pos = ((Math.log10(v) + 1) / d) * 100;
            marks += `<span style="left:${pos}%"></span>`;
            ticks += `<span style="left:${pos}%">${v}</span>`;
        });
    } else {
        const d = 3.477;
        const pts = [0.1, 1, 10, 50, 100, 300];
        pts.forEach(v => {
            let pos = ((Math.log10(v) + 1) / d) * 100;
            marks += `<span style="left:${pos}%"></span>`;
            ticks += `<span style="left:${pos}%">${v}</span>`;
        });
    }
    this._div.innerHTML = `<div style="font-weight:bold; font-size:10px; margin-bottom:5px;">${title}</div>
                           <div class="colorbar">${marks}</div>
                           <div class="ticks">${ticks}</div>`;
};
legend.addTo(map);

// --- CONTROL DE MEN√ö ---
document.getElementById("btnToggleMenu").onclick = function() {
    const menu = document.getElementById("mainControl");
    menu.classList.toggle("minimized");
    this.textContent = menu.classList.contains("minimized") ? "Obrir" : "Amagar";
};

// --- FUNCIONS ASPECTE ---
function toggleAspect() {
    const btn = document.getElementById("btnAspect");
    const control = document.getElementById("aspectControl");
    if (!aspectLayer) {
        btn.classList.add("active");
        control.style.display = "flex";
        aspectLayer = L.tileLayer('https://albverfar123.github.io/test_aspect/tiles_aspect/{z}/{x}/{y}.png', {
            minZoom: 8, maxNativeZoom: 12, maxZoom: 22, opacity: 0.7,
            errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='
        }).addTo(map);
        if(overlayRadar) overlayRadar.bringToFront();
        addAspectLegend();
    } else {
        btn.classList.remove("active");
        control.style.display = "none";
        map.removeLayer(aspectLayer);
        aspectLayer = null;
        if(legendControl) { map.removeControl(legendControl); legendControl = null; }
    }
}

function addAspectLegend() {
    legendControl = L.control({position: 'bottomleft'});
    legendControl.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');
        var labels = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
        var colors = ['#ff00ac', '#ff97dd', '#5cc75a', '#9cc75a', '#c7c55a', '#c7a15a', '#c7735a', '#990067'];
        div.innerHTML = '<strong>Aspecte</strong><br>';
        for (var i = 0; i < labels.length; i++) {
            div.innerHTML += '<i style="background:' + colors[i] + '"></i> ' + labels[i] + '<br>';
        }
        return div;
    };
    legendControl.addTo(map);
}

document.getElementById("aspectOpacity").oninput = function() { if (aspectLayer) aspectLayer.setOpacity(this.value); };
document.getElementById("btnAspect").onclick = toggleAspect;

// --- DATES I UPDATE ---
function getDates(dateIn) {
    let d = new Date(dateIn);
    const fmt = (date) => date.toISOString().slice(0,10).replace(/-/g, "");
    const fmtUI = (date) => `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
    let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
    let monday = new Date(d.getTime()); monday.setDate(diff);
    let sunday = new Date(monday.getTime()); sunday.setDate(monday.getDate() + 6);
    return {
        daily: fmt(new Date(dateIn)), weeklyStart: fmt(monday), weeklyEnd: fmt(sunday),
        trialStart: fmt(new Date(d.getTime() - 6*86400000)), trialEnd: fmt(new Date(dateIn)),
        uiStart: fmtUI(new Date(d.getTime() - 6*86400000)), uiEnd: fmtUI(new Date(dateIn)),
        uiStartNat: fmtUI(monday), uiEndNat: fmtUI(sunday)
    };
}

async function initMap() {
    try {
        const response = await fetch('bounds.json');
        const b = await response.json();
        radarBounds = [[b.lat_min, b.lon_min], [b.lat_max, b.lon_max]];
    } catch (e) { radarBounds = [[40.0, 0.0], [43.5, 3.8]]; }
    updateView(); 
}

async function updateView() {
    if (!radarBounds) return;
    legend.update();
    const dates = getDates(document.getElementById("datePicker").value);
    const status = document.getElementById("statusMsg");
    const weekDisplay = document.getElementById("weekRangeDisplay");
    
    if (overlayRadar) map.removeLayer(overlayRadar);
    stationsLayer.clearLayers();

    if (viewMode === 'daily') {
        weekDisplay.style.display = "none";
        loadRadar(`acumulats_diaris/acumulat_${dates.daily}.png`);
        // CARREGA ESTACIONS DI√ÄRIES
        loadStations(`acumulats_diaris/estacions_${dates.daily}.json`);
    } else {
        weekDisplay.style.display = "block";
        loadRadar(`acumulats_setmanals/setmanal_${dates.weeklyStart}_${dates.weeklyEnd}.png`, async (success) => {
            if (!success) {
                weekDisplay.textContent = `Setmana del ${dates.uiStart} al ${dates.uiEnd}`;
                loadRadar(`acumulats_setmanals/setmanal_${dates.trialStart}_${dates.trialEnd}.png`);
                // CARREGA ESTACIONS SETMANALS (Trial/M√≤bil)
                loadStations(`acumulats_setmanals/estacions_${dates.trialStart}_${dates.trialEnd}.json`);
            } else {
                weekDisplay.textContent = `Setmana del ${dates.uiStartNat} al ${dates.uiEndNat}`;
                // CARREGA ESTACIONS SETMANALS (Naturals)
                loadStations(`acumulats_setmanals/estacions_${dates.weeklyStart}_${dates.weeklyEnd}.json`);
            }
        });
    }
}

async function loadStations(path) {
    // Si el checkbox est√† desactivat, no fem res
    if (!document.getElementById("checkStations").checked) return;
    
    try {
        const res = await fetch(path);
        if (!res.ok) return; // Si el fitxer no existeix, sortim silenciosament
        const data = await res.json();
        
        L.geoJSON(data, {
            pointToLayer: (feature, latlng) => L.marker(latlng, {
                icon: L.divIcon({ 
                    className: 'station-label', 
                    html: feature.properties.pluja, 
                    iconSize: [25, 15] 
                })
            }).bindTooltip(`${feature.properties.nom}: ${feature.properties.pluja} mm`)
        }).addTo(stationsLayer);
    } catch (e) {
        console.log("Dades d'estacions no disponibles per a aquesta ruta");
    }
}

async function loadStations(start, end) {
    if (!document.getElementById("checkStations").checked) return;
    try {
        const res = await fetch(`acumulats_setmanals/estacions_${start}_${end}.json`);
        const data = await res.json();
        L.geoJSON(data, {
            pointToLayer: (feature, latlng) => L.marker(latlng, {
                icon: L.divIcon({ className: 'station-label', html: feature.properties.pluja, iconSize: [25, 15] })
            }).bindTooltip(`${feature.properties.nom}: ${feature.properties.pluja} mm`)
        }).addTo(stationsLayer);
    } catch (e) {}
}

document.getElementById("modeDaily").onclick = function() { viewMode='daily'; this.classList.add('active'); document.getElementById("modeWeekly").classList.remove('active'); updateView(); };
document.getElementById("modeWeekly").onclick = function() { viewMode='weekly'; this.classList.add('active'); document.getElementById("modeDaily").classList.remove('active'); updateView(); };
document.getElementById("datePicker").onchange = updateView;
document.getElementById("checkStations").onchange = updateView;
document.getElementById("prevBtn").onclick = () => { let d = new Date(datePicker.value); d.setDate(d.getDate()-1); datePicker.value=d.toISOString().slice(0,10); updateView(); };
document.getElementById("nextBtn").onclick = () => { let d = new Date(datePicker.value); d.setDate(d.getDate()+1); datePicker.value=d.toISOString().slice(0,10); updateView(); };
document.getElementById("opacitySlider").oninput = function() { if (overlayRadar) overlayRadar.setOpacity(this.value); };

let dInit = new Date(); dInit.setDate(dInit.getDate()-1);
document.getElementById("datePicker").value = dInit.toISOString().slice(0,10);

//  CODI DEL GPS ---
var userMarker = null;
document.getElementById("btnGPS").onclick = function() {
    map.locate({setView: true, maxZoom: 16});
};

map.on('locationfound', function(e) {
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.circleMarker(e.latlng, {
        radius: 8, className: 'user-location-dot', fillColor: '#007bff', fillOpacity: 1, color: 'white', weight: 2
    }).addTo(map);
    L.circle(e.latlng, e.accuracy, { color: '#007bff', fillOpacity: 0.1, weight: 1 }).addTo(map);
});

map.on('locationerror', function() {
    alert("No s'ha pogut accedir a la ubicaci√≥.");
});
    
initMap();
</script>
</body>
</html>
